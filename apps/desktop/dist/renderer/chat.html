<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Assistant Chat</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a; /* ì–´ë‘ìš´ ë°°ê²½ìƒ‰ */
            font-family: 'Arial', sans-serif;
            color: white;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 15px;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* ë“œë˜ê·¸ ì˜ì—­ ì œê±° (í”„ë ˆì„ ì‚¬ìš© ì‹œ ë¶ˆí•„ìš”) */

        .chat-header {
            text-align: center;
            margin-bottom: 10px;
            padding: 15px;
            background: rgba(78, 205, 196, 0.2);
            border-radius: 10px;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .chat-header h1 {
            margin: 0;
            color: #4ecdc4;
            font-size: 18px;
        }

        .chat-header p {
            margin: 5px 0 0 0;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }


        .chat-messages {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            overflow-x: visible; /* ë§í’ì„  ê¼¬ë¦¬ê°€ ì˜ë¦¬ì§€ ì•Šë„ë¡ */
            padding: 10px 15px; /* ì¢Œìš° íŒ¨ë”© ì¦ê°€ */
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
            -webkit-app-region: no-drag; /* ë“œë˜ê·¸ ë¹„í™œì„±í™” */
        }

        .message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 18px;
            max-width: 70%; /* ë§í’ì„  ê¼¬ë¦¬ ê³µê°„ í™•ë³´ */
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-size: 13px;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            margin-left: 10px; /* ì™¼ìª½ ì—¬ë°± */
            margin-right: 10px; /* ì˜¤ë¥¸ìª½ ì—¬ë°± */
        }

        .message.user {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.9), rgba(69, 183, 184, 0.9));
            margin-left: auto;
            text-align: left;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.user {
            margin-left: auto;
            margin-right: 10px; /* ì˜¤ë¥¸ìª½ ì—¬ë°± í™•ë³´ */
        }

        .message.user::after {
            content: '';
            position: absolute;
            right: -6px;
            bottom: 12px;
            width: 0;
            height: 0;
            border: 6px solid transparent;
            border-left-color: rgba(69, 183, 184, 0.9);
            border-top: none;
            border-right: none;
            z-index: 1;
        }

        .message.assistant {
            background: rgba(255, 255, 255, 0.95);
            margin-left: 10px; /* ì™¼ìª½ ì—¬ë°± í™•ë³´ */
            margin-right: auto;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .message.assistant::before {
            content: '';
            position: absolute;
            left: -6px;
            bottom: 12px;
            width: 0;
            height: 0;
            border: 6px solid transparent;
            border-right-color: rgba(255, 255, 255, 0.95);
            border-top: none;
            border-left: none;
            z-index: 1;
        }

        .chat-input-container {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            box-sizing: border-box;
            -webkit-app-region: no-drag; /* ë“œë˜ê·¸ ë¹„í™œì„±í™” */
        }

        .chat-input:focus {
            border-color: #4ecdc4;
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .send-btn {
            padding: 10px 20px;
            background: rgba(78, 205, 196, 0.8);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            white-space: nowrap;
            -webkit-app-region: no-drag; /* ë“œë˜ê·¸ ë¹„í™œì„±í™” */
        }

        .send-btn:hover {
            background: rgba(69, 183, 184, 0.9);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        .mic-btn {
            padding: 10px;
            background: rgba(255, 100, 100, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-app-region: no-drag;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-btn:hover {
            background: rgba(255, 80, 80, 0.9);
        }

        .mic-btn.recording {
            background: rgba(255, 50, 50, 1);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .status {
            text-align: center;
            margin-top: 5px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>ğŸ­ ì•ŒíŒŒì™€ ì±„íŒ…í•˜ê¸°</h1>
            <p>AI ë¹„ì„œ ì•ŒíŒŒì™€ ëŒ€í™”í•´ë³´ì„¸ìš”!</p>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì•ŒíŒŒì˜ˆìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ğŸ˜Š
            </div>
        </div>
        
        <div class="chat-input-container">
            <button class="mic-btn" id="micBtn" title="ìŒì„±ìœ¼ë¡œ ë§í•˜ê¸°">ğŸ¤</button>
            <input type="text" class="chat-input" id="chatInput" placeholder="ì•ŒíŒŒì—ê²Œ ë§í•´ë³´ì„¸ìš”..." onkeypress="handleKeyPress(event)">
            <button class="send-btn" onclick="sendMessage()">ì „ì†¡</button>
        </div>
        
        <div class="status" id="status">ì—°ê²°ë¨</div>
    </div>

    <script>
        // ========== ElevenLabs TTS ==========
        let currentAudio = null;
        
        async function speakText(text, emotion = 'normal') {
            const status = document.getElementById('status');
            
            // ì´ì „ ì˜¤ë””ì˜¤ ì¤‘ì§€
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            try {
                if (status) status.textContent = 'ìŒì„± ìƒì„± ì¤‘...';
                console.log('ElevenLabs TTS ìš”ì²­:', text.substring(0, 50));
                
                const response = await fetch('http://localhost:3030/text-to-speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text,
                        model: 'eleven_multilingual_v2'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`TTS ì˜¤ë¥˜: ${response.status}`);
                }
                
                const audioBlob = await response.blob();
                console.log('TTS ì‘ë‹µ ë°›ìŒ, í¬ê¸°:', audioBlob.size);
                
                const audioUrl = URL.createObjectURL(audioBlob);
                currentAudio = new Audio(audioUrl);
                
                currentAudio.onplay = () => {
                    console.log('ìŒì„± ì¬ìƒ ì‹œì‘');
                    if (status) status.textContent = 'ìŒì„± ì¬ìƒ ì¤‘...';
                };
                
                currentAudio.onended = () => {
                    console.log('ìŒì„± ì¬ìƒ ì™„ë£Œ');
                    if (status) status.textContent = 'ì—°ê²°ë¨';
                    URL.revokeObjectURL(audioUrl);
                    currentAudio = null;
                };
                
                currentAudio.onerror = (e) => {
                    console.error('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:', e);
                    if (status) status.textContent = 'ì—°ê²°ë¨';
                    URL.revokeObjectURL(audioUrl);
                    currentAudio = null;
                };
                
                await currentAudio.play();
                
            } catch (error) {
                console.error('TTS ì˜¤ë¥˜:', error);
                if (status) status.textContent = 'ì—°ê²°ë¨';
            }
        }
        
        // ========== ë©”ì‹œì§€ ì „ì†¡ ==========
        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            console.log('sendMessage í˜¸ì¶œë¨');
            const input = document.getElementById('chatInput');
            const messages = document.getElementById('chatMessages');
            const status = document.getElementById('status');
            
            if (!input || !messages || !status) {
                console.error('í•„ìˆ˜ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', { input, messages, status });
                return;
            }
            
            const message = input.value.trim();
            console.log('ì…ë ¥ëœ ë©”ì‹œì§€:', message);
            
            if (!message) {
                console.log('ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆìŒ');
                return;
            }

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            const userMessage = document.createElement('div');
            userMessage.className = 'message user';
            userMessage.textContent = message;
            messages.appendChild(userMessage);
            
            input.value = '';
            input.focus(); // ì…ë ¥ í›„ ë‹¤ì‹œ í¬ì»¤ìŠ¤
            status.textContent = 'AIê°€ ì‘ë‹µ ì¤‘...';
            // ìŠ¤í¬ë¡¤ì„ ì•½ê°„ ì§€ì—°ì‹œì¼œ DOM ì—…ë°ì´íŠ¸ í›„ ì‹¤í–‰
            setTimeout(() => {
                messages.scrollTop = messages.scrollHeight;
            }, 100);

            try {
                // 1. ë¨¼ì € í…ìŠ¤íŠ¸ ì‘ë‹µë§Œ ë°›ê¸° (ë¹ ë¥¸ ì‘ë‹µ)
                const requestBody = { 
                    message: message
                };
                console.log('í´ë¼ì´ì–¸íŠ¸ ìš”ì²­:', requestBody);
                
                const response = await fetch('http://localhost:3030/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('ì„œë²„ ì‘ë‹µ:', data);
                
                // 2. AI ì‘ë‹µ í‘œì‹œ
                if (data.reply) {
                    const aiMessage = document.createElement('div');
                    aiMessage.className = 'message assistant';
                    aiMessage.textContent = data.reply;
                    messages.appendChild(aiMessage);
                    setTimeout(() => {
                        messages.scrollTop = messages.scrollHeight;
                    }, 100);
                }
                
                // 3. Web Speech APIë¡œ TTS ì²˜ë¦¬ (ë¸Œë¼ìš°ì € ë‚´ì¥)
                if (data.reply) {
                    speakText(data.reply, data.emotion || 'normal');
                }
                
                input.focus(); // ì‘ë‹µ í›„ ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤
                setTimeout(() => {
                    messages.scrollTop = messages.scrollHeight;
                }, 100);
                
            } catch (error) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'message assistant';
                errorMessage.textContent = `ì˜¤ë¥˜: ${error.message}`;
                messages.appendChild(errorMessage);
                
                status.textContent = 'ì—°ê²° ì˜¤ë¥˜';
                input.focus();
                setTimeout(() => {
                    messages.scrollTop = messages.scrollHeight;
                }, 100);
            }
        }

        // ì—”í„°í‚¤ ì²˜ë¦¬
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ìŒì„± ë…¹ìŒ ê¸°ëŠ¥
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        async function startRecording() {
            console.log('startRecording í˜¸ì¶œë¨');
            try {
                console.log('ë§ˆì´í¬ ì ‘ê·¼ ì‹œë„...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('ë§ˆì´í¬ ì ‘ê·¼ ì„±ê³µ');
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendVoiceMessage(audioBlob);
                    
                    // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                const micBtn = document.getElementById('micBtn');
                const status = document.getElementById('status');
                micBtn.classList.add('recording');
                micBtn.textContent = 'â¹ï¸';
                status.textContent = 'ë…¹ìŒ ì¤‘... (ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì „ì†¡)';
                
            } catch (error) {
                console.error('ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:', error);
                const status = document.getElementById('status');
                status.textContent = 'ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤';
                alert('ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”!');
            }
        }

        function stopRecording() {
            console.log('stopRecording í˜¸ì¶œë¨, mediaRecorder:', mediaRecorder, 'isRecording:', isRecording);
            if (mediaRecorder && isRecording) {
                console.log('ë…¹ìŒ ì¤‘ì§€ ì¤‘...');
                mediaRecorder.stop();
                isRecording = false;
                
                const micBtn = document.getElementById('micBtn');
                const status = document.getElementById('status');
                micBtn.classList.remove('recording');
                micBtn.textContent = 'ğŸ¤';
                status.textContent = 'ìŒì„± ì „ì†¡ ì¤‘...';
            }
        }

        async function sendVoiceMessage(audioBlob) {
            try {
                const messages = document.getElementById('chatMessages');
                const status = document.getElementById('status');
                
                // ğŸ”¥ íƒ€ì„ì•„ì›ƒ í—¬í¼ í•¨ìˆ˜
                const fetchWithTimeout = (url, options, timeout = 20000) => {
                    return Promise.race([
                        fetch(url, options),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('ìš”ì²­ ì‹œê°„ ì´ˆê³¼ (20ì´ˆ)')), timeout)
                        )
                    ]);
                };
                
                // 1. ë¨¼ì € STTë¡œ ìŒì„±ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
                status.textContent = 'ğŸ™ï¸ ìŒì„± ì¸ì‹ ì¤‘...';
                const sttFormData = new FormData();
                sttFormData.append('audio', audioBlob, 'recording.webm');
                
                const sttResponse = await fetchWithTimeout('http://localhost:3030/speech-to-text', {
                    method: 'POST',
                    body: sttFormData
                }, 20000);
                
                if (!sttResponse.ok) {
                    const errorData = await sttResponse.json().catch(() => ({}));
                    throw new Error(errorData.error || `STT ì˜¤ë¥˜: ${sttResponse.status}`);
                }
                
                const sttData = await sttResponse.json();
                const recognizedText = sttData.text;
                
                if (!recognizedText || recognizedText.trim().length === 0) {
                    status.textContent = 'ìŒì„±ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                    return;
                }
                
                // ì‚¬ìš©ì ìŒì„± ë©”ì‹œì§€ í‘œì‹œ
                const userMessage = document.createElement('div');
                userMessage.className = 'message user';
                userMessage.textContent = recognizedText;
                messages.appendChild(userMessage);
                
                // 2. ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¡œ ì±„íŒ… ìš”ì²­ (í…ìŠ¤íŠ¸ë§Œ ë¨¼ì € ë°›ê¸°)
                const requestBody = { 
                    message: recognizedText
                };
                
                status.textContent = 'AIê°€ ì‘ë‹µ ì¤‘...';
                
                const response = await fetch('http://localhost:3030/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('ìŒì„± ì±„íŒ… ì‘ë‹µ:', data);
                
                // 2-1. AI ì‘ë‹µ í‘œì‹œ
                if (data.reply) {
                    const aiMessage = document.createElement('div');
                    aiMessage.className = 'message assistant';
                    aiMessage.textContent = data.reply;
                    messages.appendChild(aiMessage);
                    setTimeout(() => {
                        messages.scrollTop = messages.scrollHeight;
                    }, 100);
                }
                
                // 3. Web Speech APIë¡œ TTS ì²˜ë¦¬ (ë¸Œë¼ìš°ì € ë‚´ì¥)
                if (data.reply) {
                    speakText(data.reply, data.emotion || 'normal');
                }
                
                setTimeout(() => {
                    messages.scrollTop = messages.scrollHeight;
                }, 100);
                
            } catch (error) {
                console.error('ìŒì„± ì „ì†¡ ì˜¤ë¥˜:', error);
                status.textContent = 'ìŒì„± ì „ì†¡ ì‹¤íŒ¨: ' + error.message;
            }
        }

        // ìë™ í¬ì»¤ìŠ¤ ë° ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded ì‹¤í–‰ë¨');
            
            // ë§ˆì´í¬ ë²„íŠ¼ ì´ë²¤íŠ¸
            const micBtn = document.getElementById('micBtn');
            console.log('ë§ˆì´í¬ ë²„íŠ¼:', micBtn);
            if (micBtn) {
                micBtn.addEventListener('click', function() {
                    console.log('ë§ˆì´í¬ ë²„íŠ¼ í´ë¦­ë¨, isRecording:', isRecording);
                    if (isRecording) {
                        stopRecording();
                    } else {
                        startRecording();
                    }
                });
            } else {
                console.error('ë§ˆì´í¬ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            }
            
            // ì „ì†¡ ë²„íŠ¼ë„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¡œ ì—°ê²° (onclick ëŒ€ì‹ )
            const sendBtn = document.querySelector('.send-btn');
            if (sendBtn) {
                sendBtn.addEventListener('click', function() {
                    console.log('ì „ì†¡ ë²„íŠ¼ í´ë¦­ë¨');
                    sendMessage();
                });
            }
            
            const input = document.getElementById('chatInput');
            if (input) {
                // í¬ì»¤ìŠ¤ ì„¤ì •
                setTimeout(() => {
                    input.focus();
                }, 100);
                
                // ì…ë ¥ í•„ë“œê°€ í•­ìƒ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡
                input.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
                
                // ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ìœ ì§€
                input.addEventListener('blur', function() {
                    setTimeout(() => {
                        input.focus();
                    }, 50);
                });
            }
            
            // ë©”ì‹œì§€ ì˜ì—­ ìë™ ìŠ¤í¬ë¡¤
            const messages = document.getElementById('chatMessages');
            if (messages) {
                messages.scrollTop = messages.scrollHeight;
            }
        });
    </script>
</body>
</html>
