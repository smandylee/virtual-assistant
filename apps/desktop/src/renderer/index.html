<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>Assistant</title>
<style>
  * { box-sizing: border-box; }
  body{margin:0;font-family:'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;background:#0b0e13;color:#e9eef6}
  #app{display:flex;flex-direction:column;height:100vh}
  header{padding:12px 16px;background:#121723;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center}
  header strong{font-size:18px}
  .header-btn{padding:6px 12px;border-radius:6px;border:0;background:#2d3748;color:#e9eef6;cursor:pointer;font-size:12px;transition:background 0.2s}
  .header-btn:hover{background:#3d4758}
  main{flex:1;overflow:auto;padding:16px;position:relative}
  .msg{max-width:720px;margin:8px 0;line-height:1.6;padding:10px 14px;border-radius:12px}
  .me{color:#a3d3ff;background:#1a2332;margin-left:auto;text-align:right}
  .ai{color:#e9eef6;background:#1e293b}
  footer{display:flex;gap:8px;padding:12px;background:#121723;border-top:1px solid #222}
  input{flex:1;padding:12px;border-radius:8px;border:1px solid #333;background:#0f141b;color:#e9eef6;font-size:14px}
  input:focus{outline:none;border-color:#3b82f6}
  button{padding:10px 16px;border-radius:8px;border:0;background:#3b82f6;color:white;cursor:pointer;font-weight:500;transition:background 0.2s}
  button:hover{background:#2563eb}
  button:disabled{background:#555;cursor:not-allowed}
  
  /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ */
  #dropzone{
    display:none;
    position:absolute;
    top:50%;left:50%;transform:translate(-50%,-50%);
    width:90%;max-width:500px;
    padding:60px 40px;
    border:3px dashed #3b82f6;
    border-radius:20px;
    background:rgba(59,130,246,0.1);
    text-align:center;
    z-index:100;
    transition:all 0.3s ease;
  }
  #dropzone.active{display:block}
  #dropzone.dragover{background:rgba(59,130,246,0.25);border-color:#60a5fa;transform:translate(-50%,-50%) scale(1.02)}
  #dropzone h2{margin:0 0 10px;font-size:24px;color:#60a5fa}
  #dropzone p{margin:0;color:#94a3b8;font-size:14px}
  #dropzone .icon{font-size:50px;margin-bottom:15px}
  
  /* íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ */
  #upload-btn{
    position:fixed;
    bottom:80px;right:20px;
    width:56px;height:56px;
    border-radius:50%;
    background:linear-gradient(135deg,#3b82f6,#8b5cf6);
    color:white;
    font-size:24px;
    border:0;
    cursor:pointer;
    box-shadow:0 4px 15px rgba(59,130,246,0.4);
    transition:all 0.3s ease;
    z-index:50;
  }
  #upload-btn:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(59,130,246,0.5)}
  
  /* ë¶„ì„ ê²°ê³¼ */
  .analysis-result{
    background:#1e293b;
    border-left:4px solid #3b82f6;
    padding:15px;
    margin:10px 0;
    border-radius:0 12px 12px 0;
    max-width:100%;
  }
  .analysis-result h3{margin:0 0 10px;color:#60a5fa;font-size:16px}
  .analysis-result pre{
    white-space:pre-wrap;
    word-wrap:break-word;
    font-family:inherit;
    margin:0;
    font-size:13px;
    line-height:1.6;
  }
  
  /* ë¡œë”© ìƒíƒœ */
  .loading{
    display:inline-block;
    width:20px;height:20px;
    border:2px solid #333;
    border-top-color:#3b82f6;
    border-radius:50%;
    animation:spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  
  /* íŒŒì¼ ì…ë ¥ ìˆ¨ê¸°ê¸° */
  #file-input{display:none}
</style>
</head>
<body>
<div id="app">
  <header>
    <strong>ğŸ¤– Assistant</strong>
    <button class="header-btn" id="toggle-drop">ğŸ“„ ë¬¸ì„œ ë¶„ì„</button>
  </header>
  <main id="log">
    <!-- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ -->
    <div id="dropzone">
      <div class="icon">ğŸ“‚</div>
      <h2>íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë¡­í•˜ì„¸ìš”</h2>
      <p>PDF, Word, PowerPoint, í…ìŠ¤íŠ¸ íŒŒì¼ ì§€ì›</p>
      <p style="margin-top:10px;font-size:12px;color:#64748b">ë˜ëŠ” í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</p>
    </div>
  </main>
  <footer>
    <input id="input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
    <button id="send">ì „ì†¡</button>
  </footer>
</div>

<!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ -->
<input type="file" id="file-input" accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.md,.json,.csv" />

<!-- í”Œë¡œíŒ… ì—…ë¡œë“œ ë²„íŠ¼ -->
<button id="upload-btn" title="ë¬¸ì„œ ë¶„ì„">ğŸ“„</button>

<script type="module">
const API = "http://localhost:3030";
const log = document.getElementById("log");
const input = document.getElementById("input");
const send = document.getElementById("send");
const dropzone = document.getElementById("dropzone");
const toggleDrop = document.getElementById("toggle-drop");
const uploadBtn = document.getElementById("upload-btn");
const fileInput = document.getElementById("file-input");

console.log("API URL:", API);

// ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
function add(role, text, isHtml = false) {
  const div = document.createElement("div");
  div.className = "msg " + (role === "user" ? "me" : "ai");
  if (isHtml) {
    div.innerHTML = text;
  } else {
    div.textContent = (role === "user" ? "" : "") + text;
  }
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

// ë¶„ì„ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
function addAnalysisResult(fileName, summary) {
  const div = document.createElement("div");
  div.className = "analysis-result";
  div.innerHTML = `
    <h3>ğŸ“„ ${fileName} ë¶„ì„ ì™„ë£Œ</h3>
    <pre>${summary}</pre>
  `;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

// ë¡œë”© ë©”ì‹œì§€ ì¶”ê°€
function addLoading(text) {
  const div = document.createElement("div");
  div.className = "msg ai";
  div.id = "loading-msg";
  div.innerHTML = `<span class="loading"></span> ${text}`;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

// ë¡œë”© ë©”ì‹œì§€ ì œê±°
function removeLoading() {
  const loadingMsg = document.getElementById("loading-msg");
  if (loadingMsg) loadingMsg.remove();
}

// íŒŒì¼ ì—…ë¡œë“œ ë° ë¶„ì„
async function analyzeDocument(file) {
  addLoading(`ğŸ“„ "${file.name}" ë¶„ì„ ì¤‘...`);
  
  try {
    const formData = new FormData();
    formData.append('document', file);
    
    const response = await fetch(API + "/analyze-and-notepad", {
      method: "POST",
      body: formData
    });
    
    const result = await response.json();
    removeLoading();
    
    if (result.success) {
      addAnalysisResult(result.fileName, result.summary);
      add("ai", result.message);
    } else {
      add("ai", `âŒ ë¶„ì„ ì‹¤íŒ¨: ${result.error}`);
    }
  } catch (error) {
    removeLoading();
    console.error("ë¶„ì„ ì˜¤ë¥˜:", error);
    add("ai", `âŒ ì˜¤ë¥˜: ${error.message}`);
  }
}

// ë“œë¡­ì¡´ í† ê¸€
toggleDrop.onclick = () => {
  dropzone.classList.toggle("active");
};

uploadBtn.onclick = () => {
  dropzone.classList.toggle("active");
};

// ë“œë¡­ì¡´ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ
dropzone.onclick = () => {
  fileInput.click();
};

// íŒŒì¼ ì„ íƒ ì‹œ
fileInput.onchange = (e) => {
  const file = e.target.files[0];
  if (file) {
    dropzone.classList.remove("active");
    analyzeDocument(file);
  }
  fileInput.value = ""; // ì´ˆê¸°í™”
};

// ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
document.addEventListener("dragover", (e) => {
  e.preventDefault();
  dropzone.classList.add("active");
  dropzone.classList.add("dragover");
});

document.addEventListener("dragleave", (e) => {
  if (e.target === document || e.target === document.body) {
    dropzone.classList.remove("dragover");
  }
});

document.addEventListener("drop", (e) => {
  e.preventDefault();
  dropzone.classList.remove("active");
  dropzone.classList.remove("dragover");
  
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    const file = files[0];
    const ext = file.name.split('.').pop().toLowerCase();
    const allowedExts = ['pdf', 'doc', 'docx', 'ppt', 'pptx', 'txt', 'md', 'json', 'csv'];
    
    if (allowedExts.includes(ext)) {
      analyzeDocument(file);
    } else {
      add("ai", `âŒ ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤: .${ext}\nì§€ì› í˜•ì‹: PDF, Word, PowerPoint, í…ìŠ¤íŠ¸ íŒŒì¼`);
    }
  }
});

// ì±„íŒ… ì „ì†¡
send.onclick = async () => {
  const message = input.value.trim();
  if (!message) return;
  
  console.log("Sending message:", message);
  add("user", message);
  input.value = "";
  send.disabled = true;
  
  try {
    const r = await fetch(API + "/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message })
    });
    const j = await r.json();
    console.log("Response:", j);
    add("ai", j.reply || j.error || "(ì‘ë‹µ ì—†ìŒ)");
  } catch (error) {
    console.error("Error:", error);
    add("ai", "âŒ ì˜¤ë¥˜: " + error.message);
  }
  
  send.disabled = false;
};

input.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    send.click();
  }
});

// ì´ˆê¸° ë©”ì‹œì§€
add("ai", "ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ğŸ“„ ë¬¸ì„œë¥¼ ë¶„ì„í•˜ë ¤ë©´ íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•˜ê±°ë‚˜ ì˜¤ë¥¸ìª½ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”!");
</script>
</body>
</html>
